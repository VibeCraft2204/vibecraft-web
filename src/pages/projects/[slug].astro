---
import { getCollection, render } from 'astro:content';
import { Image } from 'astro:assets';
import PageLayout from '../../layouts/PageLayout.astro';
import Divider from '../../components/Divider.astro';
import SectionHeader from '../../components/SectionHeader.astro';
import ProjectCard from '../../components/ProjectCard.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import MetricBar from '../../components/MetricBar.astro';
import ImageGallery from '../../components/ImageGallery.astro';
import ProjectNav from '../../components/ProjectNav.astro';

const base = import.meta.env.BASE_URL.replace(/\/?$/, '/');

export async function getStaticPaths() {
  const projects = await getCollection('projects');
  return projects.map((project) => ({
    params: { slug: project.slug },
    props: { project },
  }));
}

const { project } = Astro.props;
const { Content, headings } = await render(project);

function formatPeriod(start?: string, end?: string): string {
  if (!start) return '-';
  const fmt = (d: string) => d.substring(0, 7).replace('-', '.');
  if (end) return `${fmt(start)} — ${fmt(end)}`;
  return `${fmt(start)} — 진행중`;
}

// All projects sorted by period_start (descending)
const allProjects = (await getCollection('projects')).sort((a, b) => {
  const aDate = a.data.period_start || '0000';
  const bDate = b.data.period_start || '0000';
  return aDate > bDate ? -1 : 1;
});

// Prev/Next navigation
const currentIndex = allProjects.findIndex((p) => p.slug === project.slug);
const prevProject = currentIndex < allProjects.length - 1 ? allProjects[currentIndex + 1] : undefined;
const nextProject = currentIndex > 0 ? allProjects[currentIndex - 1] : undefined;

// Related projects: same field overlap, exclude current, max 3
const currentFields = new Set(project.data.field);
const relatedProjects = allProjects
  .filter(
    (p) =>
      p.slug !== project.slug &&
      p.data.field.some((f: string) => currentFields.has(f))
  )
  .sort(() => Math.random() - 0.5)
  .slice(0, 3);

const metaGrid = [
  { label: '클라이언트', value: project.data.company || '-' },
  { label: '기간', value: formatPeriod(project.data.period_start, project.data.period_end) },
  { label: '분야', value: project.data.field.join(', ') || '-' },
  { label: '팀', value: project.data.team.length > 0 ? project.data.team.join(', ') : '-' },
];
---

<PageLayout
  title={`${project.data.title} — VibeCraft`}
  description={project.data.summary}
>
  <article class="detail">
    <div class="container">
      <!-- Breadcrumb -->
      <nav class="breadcrumb">
        <a href={`${base}projects/`}>Work</a>
        <span class="sep">/</span>
        <span>{project.data.title}</span>
      </nav>

      <!-- Header -->
      <h1>{project.data.title}</h1>
      <p class="summary">{project.data.summary}</p>

      <!-- Meta Grid -->
      <div class="meta-grid">
        {
          metaGrid.map((m) => (
            <div class="meta-item">
              <span class="meta-label">{m.label}</span>
              <span class="meta-value">{m.value}</span>
            </div>
          ))
        }
      </div>

      <!-- Cover Image -->
      {project.data.cover && (
        <div class="cover-image">
          <Image src={project.data.cover} alt={project.data.title} width={1200} format="webp" quality={80} />
        </div>
      )}

      <!-- Metrics -->
      <MetricBar metrics={project.data.metrics} />

      <Divider />

      <!-- Table of Contents -->
      <TableOfContents headings={headings} />

      <!-- Content -->
      <div class="prose">
        <Content />
      </div>

      <!-- Gallery -->
      <ImageGallery images={project.data.gallery} alt={project.data.title} />

      <Divider />

      <!-- Tech Stack -->
      {
        project.data.tech.length > 0 && (
          <div class="tech-section">
            <h3 class="tech-heading">기술 스택</h3>
            <div class="tech-list">
              {project.data.tech.map((t: string) => (
                <span class="tech-tag">{t}</span>
              ))}
            </div>
          </div>
        )
      }

      <!-- Project Navigation -->
      <ProjectNav
        prev={prevProject ? { slug: prevProject.slug, title: prevProject.data.title } : undefined}
        next={nextProject ? { slug: nextProject.slug, title: nextProject.data.title } : undefined}
      />
    </div>
  </article>

  <!-- Related Projects -->
  {
    relatedProjects.length > 0 && (
      <>
        <Divider />
        <section class="section related">
          <div class="container">
            <SectionHeader title="Related Work" />
            <div class="related-grid">
              {relatedProjects.map((rp) => (
                <ProjectCard
                  title={rp.data.title}
                  summary={rp.data.summary}
                  tech={rp.data.tech}
                  slug={rp.slug}
                  field={rp.data.field}
                  cover={rp.data.cover}
                />
              ))}
            </div>
          </div>
        </section>
      </>
    )
  }
</PageLayout>

<style>
  .detail {
    padding-top: 140px;
  }

  .breadcrumb {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 32px;
  }

  .breadcrumb a {
    transition: color var(--transition-fast);
  }

  .breadcrumb a:hover {
    color: var(--text);
  }

  .sep {
    margin: 0 8px;
    color: var(--border);
  }

  h1 {
    font-size: clamp(32px, 4vw, 48px);
    font-weight: 600;
    letter-spacing: -0.03em;
    line-height: 1.2;
    max-width: 700px;
  }

  .summary {
    margin-top: 12px;
    font-size: 17px;
    color: var(--text-secondary);
    line-height: 1.7;
    max-width: 600px;
  }

  /* Meta Grid */
  .meta-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0;
    margin-top: 48px;
    margin-bottom: 48px;
    border: 1px solid var(--border);
  }

  .meta-item {
    padding: 20px 24px;
    border-right: 1px solid var(--border);
  }

  .meta-item:last-child {
    border-right: none;
  }

  .meta-label {
    display: block;
    font-size: 11px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--text-tertiary);
    margin-bottom: 6px;
  }

  .meta-value {
    font-size: 15px;
    font-weight: 500;
  }

  /* Cover Image */
  .cover-image {
    margin-bottom: 48px;
    border-radius: 6px;
    overflow: hidden;
  }

  .cover-image img {
    width: 100%;
    height: auto;
    display: block;
  }

  /* Tech Stack */
  .tech-section {
    margin: 40px 0 48px;
  }

  .tech-heading {
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text-tertiary);
    margin-bottom: 12px;
  }

  .tech-list {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .tech-tag {
    font-size: 11px;
    letter-spacing: 0.04em;
    padding: 5px 12px;
    border: 1px solid var(--border);
    border-radius: 2px;
    color: var(--text-secondary);
  }

  /* Related */
  .related-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 48px;
    margin-top: 48px;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .detail {
      padding-top: 120px;
    }

    .meta-grid {
      grid-template-columns: 1fr 1fr;
    }

    .meta-item:nth-child(2) {
      border-right: none;
    }

    .meta-item:nth-child(1),
    .meta-item:nth-child(2) {
      border-bottom: 1px solid var(--border);
    }

    .related-grid {
      grid-template-columns: 1fr;
      gap: 40px;
    }
  }
</style>
