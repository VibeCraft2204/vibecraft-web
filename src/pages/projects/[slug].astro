---
import { getCollection, render } from 'astro:content';
import PageLayout from '../../layouts/PageLayout.astro';
import Divider from '../../components/Divider.astro';
import SectionHeader from '../../components/SectionHeader.astro';
import ProjectCard from '../../components/ProjectCard.astro';
import Stats from '../../components/Stats.astro';

const base = import.meta.env.BASE_URL.replace(/\/?$/, '/');

export async function getStaticPaths() {
  const projects = await getCollection('projects');
  return projects.map((project) => ({
    params: { slug: project.slug },
    props: { project },
  }));
}

const { project } = Astro.props;
const { Content } = await render(project);

const serviceLabels: Record<string, string> = {
  'web-development': '웹 개발',
  'app-development': '앱 개발',
  'data-ai': '데이터/AI',
  automation: '자동화',
  consulting: '컨설팅',
};

const industryLabels: Record<string, string> = {
  fnb: 'F&B',
  fintech: '핀테크',
  healthcare: '헬스케어',
  education: '교육',
  blockchain: '블록체인',
  ecommerce: '이커머스',
  saas: 'SaaS',
  government: '공공',
  general: '일반',
};

const statusLabels: Record<string, string> = {
  completed: '완료',
  'in-progress': '진행중',
  planned: '예정',
};

// Related projects: same serviceType, exclude current, max 3
const allProjects = await getCollection('projects');
const relatedProjects = allProjects
  .filter(
    (p) =>
      p.data.serviceType === project.data.serviceType &&
      p.slug !== project.slug
  )
  .sort(() => Math.random() - 0.5)
  .slice(0, 3);

const metaGrid = [
  { label: '클라이언트', value: project.data.client },
  { label: '기간', value: project.data.period },
  { label: '서비스', value: serviceLabels[project.data.serviceType] || project.data.serviceType },
  { label: '산업', value: industryLabels[project.data.industry] || project.data.industry },
];
---

<PageLayout
  title={`${project.data.title} — VibeCraft`}
  description={project.data.summary}
>
  <article class="detail">
    <div class="container">
      <!-- Breadcrumb -->
      <nav class="breadcrumb">
        <a href={`${base}projects/`}>Work</a>
        <span class="sep">/</span>
        <span>{project.data.title}</span>
      </nav>

      <!-- Header -->
      <h1>{project.data.title}</h1>
      <p class="summary">{project.data.summary}</p>

      <!-- Meta Grid -->
      <div class="meta-grid">
        {
          metaGrid.map((m) => (
            <div class="meta-item">
              <span class="meta-label">{m.label}</span>
              <span class="meta-value">{m.value}</span>
            </div>
          ))
        }
      </div>

      <Divider />

      <!-- Content -->
      <div class="prose">
        <Content />
      </div>

      <Divider />

      <!-- Metrics -->
      {
        project.data.metrics && project.data.metrics.length > 0 && (
          <div class="metrics-section">
            <Stats
              items={project.data.metrics.map((m: { label: string; value: string }) => ({
                number: m.value,
                label: m.label,
              }))}
            />
          </div>
        )
      }

      <!-- Tech Stack -->
      {
        project.data.techStack.length > 0 && (
          <div class="tech-section">
            <h3 class="tech-heading">기술 스택</h3>
            <div class="tech-list">
              {project.data.techStack.map((tech: string) => (
                <span class="tech-tag">{tech}</span>
              ))}
            </div>
          </div>
        )
      }
    </div>
  </article>

  <!-- Related Projects -->
  {
    relatedProjects.length > 0 && (
      <>
        <Divider />
        <section class="section related">
          <div class="container">
            <SectionHeader title="Related Work" />
            <div class="related-grid">
              {relatedProjects.map((rp) => (
                <ProjectCard
                  title={rp.data.title}
                  summary={rp.data.summary}
                  techStack={rp.data.techStack}
                  slug={rp.slug}
                  serviceType={rp.data.serviceType}
                />
              ))}
            </div>
          </div>
        </section>
      </>
    )
  }
</PageLayout>

<style>
  .detail {
    padding-top: 140px;
  }

  .breadcrumb {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 32px;
  }

  .breadcrumb a {
    transition: color var(--transition-fast);
  }

  .breadcrumb a:hover {
    color: var(--text);
  }

  .sep {
    margin: 0 8px;
    color: var(--border);
  }

  h1 {
    font-size: clamp(32px, 4vw, 48px);
    font-weight: 600;
    letter-spacing: -0.03em;
    line-height: 1.2;
    max-width: 700px;
  }

  .summary {
    margin-top: 12px;
    font-size: 17px;
    color: var(--text-secondary);
    line-height: 1.7;
    max-width: 600px;
  }

  /* Meta Grid */
  .meta-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0;
    margin-top: 48px;
    margin-bottom: 48px;
    border: 1px solid var(--border);
  }

  .meta-item {
    padding: 20px 24px;
    border-right: 1px solid var(--border);
  }

  .meta-item:last-child {
    border-right: none;
  }

  .meta-label {
    display: block;
    font-size: 11px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--text-tertiary);
    margin-bottom: 6px;
  }

  .meta-value {
    font-size: 15px;
    font-weight: 500;
  }

  /* Metrics */
  .metrics-section {
    margin: 48px 0;
  }

  /* Tech Stack */
  .tech-section {
    margin: 40px 0 48px;
  }

  .tech-heading {
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text-tertiary);
    margin-bottom: 12px;
  }

  .tech-list {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .tech-tag {
    font-size: 11px;
    letter-spacing: 0.04em;
    padding: 5px 12px;
    border: 1px solid var(--border);
    border-radius: 2px;
    color: var(--text-secondary);
  }

  /* Related */
  .related-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 48px;
    margin-top: 48px;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .detail {
      padding-top: 120px;
    }

    .meta-grid {
      grid-template-columns: 1fr 1fr;
    }

    .meta-item:nth-child(2) {
      border-right: none;
    }

    .meta-item:nth-child(1),
    .meta-item:nth-child(2) {
      border-bottom: 1px solid var(--border);
    }

    .related-grid {
      grid-template-columns: 1fr;
      gap: 40px;
    }
  }
</style>
