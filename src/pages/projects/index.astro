---
import { getCollection } from 'astro:content';
import PageLayout from '../../layouts/PageLayout.astro';
import Divider from '../../components/Divider.astro';
import SectionHeader from '../../components/SectionHeader.astro';
import ProjectCard from '../../components/ProjectCard.astro';

const base = import.meta.env.BASE_URL.replace(/\/?$/, '/');
const allProjects = await getCollection('projects');

// Extract unique field values for filters
const allFields = [...new Set(allProjects.flatMap((p) => p.data.field))].sort();
const allTechStacks = [...new Set(allProjects.flatMap((p) => p.data.tech))].sort();
const allCompanies = [...new Set(allProjects.map((p) => p.data.company).filter(Boolean))].sort();

const fieldLabels: Record<string, string> = {
  'B/E': '백엔드',
  'F/E': '프론트엔드',
  DB: '데이터베이스',
  AI: 'AI/ML',
  Data: '데이터',
  DevOps: 'DevOps',
  IoT: 'IoT',
  'APP(Android)': 'Android',
  'APP(Cross Platform)': '크로스플랫폼',
  '특허': '특허',
};

// Sort: featured first, then by period_start descending
const sortedProjects = allProjects.sort((a, b) => {
  if (a.data.featured !== b.data.featured) return a.data.featured ? -1 : 1;
  const aDate = a.data.period_start || '0000';
  const bDate = b.data.period_start || '0000';
  return aDate > bDate ? -1 : 1;
});
---

<PageLayout
  title="Work — VibeCraft"
  description="VibeCraft의 프로젝트 포트폴리오. 웹 개발, 앱 개발, 데이터/AI 등 다양한 프로젝트를 확인하세요."
>
  <section class="page-hero">
    <div class="container">
      <h1>Work</h1>
      <p>{allProjects.length}개의 프로젝트</p>
    </div>
  </section>

  <Divider />

  <!-- Filters -->
  <section class="filter-section">
    <div class="container">
      <div class="search-group">
        <input type="search" id="project-search" placeholder="프로젝트 검색..."
               aria-label="프로젝트 검색" autocomplete="off" />
      </div>

      <div class="filter-group">
        <span class="filter-label">분야</span>
        <div class="filter-buttons" data-axis="field" role="group" aria-label="분야 필터">
          <button class="filter-btn active" data-value="all" aria-pressed="true">All</button>
          {
            allFields.map((f) => (
              <button class="filter-btn" data-value={f} aria-pressed="false">
                {fieldLabels[f] || f}
              </button>
            ))
          }
        </div>
      </div>

      <div class="filter-group">
        <span class="filter-label">회사</span>
        <div class="filter-buttons" data-axis="company" role="group" aria-label="회사 필터">
          <button class="filter-btn active" data-value="all" aria-pressed="true">All</button>
          {
            allCompanies.map((c) => (
              <button class="filter-btn" data-value={c} aria-pressed="false">
                {c}
              </button>
            ))
          }
        </div>
      </div>

      <div class="filter-group">
        <span class="filter-label">기술</span>
        <div class="filter-buttons filter-buttons-scroll" data-axis="tech" role="group" aria-label="기술 필터">
          <button class="filter-btn active" data-value="all" aria-pressed="true">All</button>
          {
            allTechStacks.map((tech) => (
              <button class="filter-btn" data-value={tech} aria-pressed="false">
                {tech}
              </button>
            ))
          }
        </div>
      </div>

      <div class="filter-actions">
        <button class="reset-btn" id="reset-filters">필터 초기화</button>
        <span class="result-count" id="result-count" aria-live="polite" role="status"
          >{allProjects.length}개 프로젝트</span
        >
      </div>
    </div>
  </section>

  <Divider />

  <!-- Project Grid -->
  <section class="section">
    <div class="container">
      <div class="projects-grid" id="projects-grid">
        {
          sortedProjects.map((project) => (
            <div
              class="project-item"
              data-field={project.data.field.join(',')}
              data-company={project.data.company}
              data-tech={project.data.tech.join(',')}
              data-title={project.data.title}
              data-summary={project.data.summary}
            >
              <ProjectCard
                title={project.data.title}
                summary={project.data.summary}
                tech={project.data.tech}
                slug={project.slug}
                field={project.data.field}
                cover={project.data.cover}
              />
            </div>
          ))
        }
      </div>

      <!-- Zero state -->
      <div class="zero-state" id="zero-state" style="display: none;">
        <p>해당 조건의 프로젝트가 없습니다.</p>
        <button class="reset-link" id="zero-reset">필터 초기화</button>
      </div>

      <!-- Show More -->
      <div class="show-more-wrap" id="show-more-wrap">
        <button class="show-more-btn" id="show-more-btn">더 보기</button>
      </div>
    </div>
  </section>
</PageLayout>

<style>
  /* Page Hero */
  .page-hero {
    padding: 140px 0 48px;
  }

  .page-hero h1 {
    font-family: var(--font-display);
    font-size: clamp(36px, 5vw, 56px);
    font-weight: 600;
    letter-spacing: -0.03em;
    line-height: 1.1;
  }

  .page-hero p {
    margin-top: 12px;
    font-size: 15px;
    color: var(--text-secondary);
  }

  /* Filter Section */
  .filter-section {
    padding: 32px 0;
  }

  .search-group {
    margin-bottom: 24px;
  }

  .search-group input {
    width: 100%;
    padding: 10px 16px;
    font-size: 14px;
    font-family: var(--font);
    border: 1px solid var(--border);
    border-radius: 100px;
    background: transparent;
    color: var(--text);
    transition: border-color var(--transition-fast);
  }

  .search-group input::placeholder {
    color: var(--text-tertiary);
  }

  .search-group input:focus {
    border-color: var(--text);
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
  }

  .filter-label {
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text-tertiary);
    min-width: 40px;
    flex-shrink: 0;
  }

  .filter-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .filter-buttons-scroll {
    overflow-x: auto;
    flex-wrap: nowrap;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }

  .filter-buttons-scroll::-webkit-scrollbar {
    display: none;
  }

  .filter-btn {
    font-size: 13px;
    padding: 5px 14px;
    border: 1px solid var(--border);
    border-radius: 100px;
    color: var(--text-secondary);
    background: transparent;
    transition: all var(--transition-fast);
    white-space: nowrap;
    cursor: pointer;
  }

  .filter-btn:hover {
    border-color: var(--text-secondary);
    color: var(--text);
  }

  .filter-btn.active {
    background: var(--text);
    color: var(--bg);
    border-color: var(--text);
  }

  .filter-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
  }

  .reset-btn {
    font-size: 13px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: color var(--transition-fast);
  }

  .reset-btn:hover {
    color: var(--text);
  }

  .result-count {
    font-size: 13px;
    color: var(--text-secondary);
  }

  /* Projects Grid */
  .projects-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 48px;
  }

  .project-item {
    transition: opacity var(--transition-normal);
  }

  /* Zero State */
  .zero-state {
    text-align: center;
    padding: 80px 0;
  }

  .zero-state p {
    font-size: 16px;
    color: var(--text-secondary);
    margin-bottom: 16px;
  }

  .reset-link {
    font-size: 14px;
    font-weight: 500;
    color: var(--text);
    text-decoration: underline;
    text-underline-offset: 3px;
    cursor: pointer;
  }

  /* Show More */
  .show-more-wrap {
    text-align: center;
    margin-top: 48px;
  }

  .show-more-btn {
    font-size: 14px;
    font-weight: 500;
    padding: 12px 32px;
    border: 1px solid var(--border);
    border-radius: 100px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .show-more-btn:hover {
    border-color: var(--text);
    color: var(--text);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .page-hero {
      padding: 120px 0 32px;
    }

    .filter-group {
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }

    .filter-buttons {
      overflow-x: auto;
      flex-wrap: nowrap;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      width: 100%;
    }

    .filter-buttons::-webkit-scrollbar {
      display: none;
    }

    .projects-grid {
      grid-template-columns: 1fr;
      gap: 40px;
    }
  }
</style>

<script>
  const ITEMS_PER_PAGE = 12;
  let visibleCount = ITEMS_PER_PAGE;
  let activeFilters: Record<string, string> = {
    field: 'all',
    company: 'all',
    tech: 'all',
  };

  const grid = document.getElementById('projects-grid');
  const items = grid ? Array.from(grid.querySelectorAll('.project-item')) : [];
  const zeroState = document.getElementById('zero-state');
  const showMoreWrap = document.getElementById('show-more-wrap');
  const showMoreBtn = document.getElementById('show-more-btn');
  const resultCount = document.getElementById('result-count');
  const resetBtn = document.getElementById('reset-filters');
  const zeroReset = document.getElementById('zero-reset');
  const searchInput = document.getElementById('project-search') as HTMLInputElement | null;

  function getMatchingItems() {
    const query = (searchInput?.value || '').toLowerCase().trim();
    return items.filter((item) => {
      const el = item as HTMLElement;
      const matchField =
        activeFilters.field === 'all' ||
        (el.dataset.field || '').split(',').includes(activeFilters.field);
      const matchCompany =
        activeFilters.company === 'all' ||
        el.dataset.company === activeFilters.company;
      const matchTech =
        activeFilters.tech === 'all' ||
        (el.dataset.tech || '').split(',').includes(activeFilters.tech);
      const matchSearch = !query ||
        (el.dataset.title || '').toLowerCase().includes(query) ||
        (el.dataset.summary || '').toLowerCase().includes(query) ||
        (el.dataset.tech || '').toLowerCase().includes(query);
      return matchField && matchCompany && matchTech && matchSearch;
    });
  }

  function applyFilters() {
    const matching = getMatchingItems();

    items.forEach((item) => {
      const el = item as HTMLElement;
      el.style.display = 'none';
    });

    matching.forEach((item, i) => {
      const el = item as HTMLElement;
      el.style.display = i < visibleCount ? '' : 'none';
    });

    // Update counts
    if (resultCount) {
      resultCount.textContent = `${matching.length}개 프로젝트`;
    }

    // Zero state
    if (zeroState) {
      zeroState.style.display = matching.length === 0 ? '' : 'none';
    }

    // Show more
    if (showMoreWrap) {
      showMoreWrap.style.display =
        matching.length > visibleCount ? '' : 'none';
    }

    // Update URL
    const params = new URLSearchParams();
    if (activeFilters.field !== 'all')
      params.set('field', activeFilters.field);
    if (activeFilters.company !== 'all')
      params.set('company', activeFilters.company);
    if (activeFilters.tech !== 'all') params.set('tech', activeFilters.tech);
    const query = (searchInput?.value || '').trim();
    if (query) params.set('q', query);
    const search = params.toString();
    history.replaceState(
      null,
      '',
      search ? `?${search}` : window.location.pathname
    );
  }

  function resetFilters() {
    activeFilters = { field: 'all', company: 'all', tech: 'all' };
    visibleCount = ITEMS_PER_PAGE;
    if (searchInput) searchInput.value = '';
    document.querySelectorAll('.filter-btn').forEach((btn) => {
      const el = btn as HTMLElement;
      const isAll = el.dataset.value === 'all';
      el.classList.toggle('active', isAll);
      el.setAttribute('aria-pressed', String(isAll));
    });
    applyFilters();
  }

  // Filter button clicks
  document.querySelectorAll('.filter-buttons').forEach((group) => {
    const axis = (group as HTMLElement).dataset.axis;
    group.querySelectorAll('.filter-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        const value = (btn as HTMLElement).dataset.value || 'all';
        if (axis) activeFilters[axis] = value;
        visibleCount = ITEMS_PER_PAGE;

        // Update active state within this group
        group
          .querySelectorAll('.filter-btn')
          .forEach((b) => {
            b.classList.remove('active');
            b.setAttribute('aria-pressed', 'false');
          });
        btn.classList.add('active');
        btn.setAttribute('aria-pressed', 'true');

        applyFilters();
      });
    });
  });

  // Show more
  showMoreBtn?.addEventListener('click', () => {
    visibleCount += ITEMS_PER_PAGE;
    applyFilters();
  });

  // Search with debounce
  let debounceTimer: ReturnType<typeof setTimeout>;
  searchInput?.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      visibleCount = ITEMS_PER_PAGE;
      applyFilters();
    }, 300);
  });

  // Reset
  resetBtn?.addEventListener('click', resetFilters);
  zeroReset?.addEventListener('click', resetFilters);

  // Restore from URL on load
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.has('field')) {
    activeFilters.field = urlParams.get('field')!;
  }
  if (urlParams.has('company')) {
    activeFilters.company = urlParams.get('company')!;
  }
  if (urlParams.has('tech')) {
    activeFilters.tech = urlParams.get('tech')!;
  }
  if (urlParams.has('q') && searchInput) {
    searchInput.value = urlParams.get('q')!;
  }

  // Sync button states from URL
  Object.entries(activeFilters).forEach(([axis, value]) => {
    const group = document.querySelector(`[data-axis="${axis}"]`);
    if (group) {
      group
        .querySelectorAll('.filter-btn')
        .forEach((btn) => {
          const isActive = (btn as HTMLElement).dataset.value === value;
          btn.classList.toggle('active', isActive);
          btn.setAttribute('aria-pressed', String(isActive));
        });
    }
  });

  applyFilters();
</script>
